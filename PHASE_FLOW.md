# 별빛 우체국 Phase 흐름도

## 📊 전체 흐름

```
Phase 1: 입장
    ↓
[버튼: 나에게 온 편지라고?]
    ↓
Phase 2: 방 선택
    ↓
[버튼: '후회'의 방, '사랑'의 방, '불안'의 방, '꿈'의 방]
    ↓
Phase 3: 방에서 대화 (10-20회)
    ↓
[자동 전환: 10회 이상 대화 시]
    ↓
Phase 3.5: AI가 서랍 선택
    ↓
Phase 3.6: 서랍에서 대화 (10-20회)
    ↓
[자동 전환: 10회 이상 대화 시]
    ↓
Phase 4: 편지 발견
    ↓
Phase 5: 엔딩
```

---

## 🎯 각 Phase 상세

### Phase 1: 입장
```
부엉: "밤손님이군. ...편지가 있는데..."
입력: 버튼만 가능
버튼: [나에게 온 편지라고?]
```

### Phase 2: 방 선택
```
부엉: "네 편지는 저 문들 중 하나에..."
입력: 버튼만 가능
버튼: ['후회'의 방, '사랑'의 방, '불안'의 방, '꿈'의 방]
```

### Phase 3: 방에서 대화 (10-20회)
```
부엉: "흐음. 역시. 후회의 방이군..."
입력: 자유 입력 ✅
대화 횟수: 카운트 시작
조건: 10회 이상 대화 → 자동으로 Phase 3.5
```

**프롬프트 지침**:
- 최소 10회, 필요하면 최대 20회까지 대화
- 심층적 질문으로 유저 정보 수집
- 언제, 왜, 누가, 무엇을 같은 질문

### Phase 3.5: 서랍 선택 (자동)
```
부엉: "흐음... 이쯤이면 알겠군. (특정 서랍으로 걸어간다)"
부엉: "여기다. '미완의 악보들' 서랍."
입력: 자동 진행
AI: 대화 내용 분석 → 적절한 서랍 이름 생성
```

**서랍 이름 예시**:
- 미완의 악보들
- 멈춰버린 나침반
- 안전지대 표지판
- 놓쳐버린 황금 티켓
- 깨진 거울
- 쓰지 못한 편지
- 시든 꽃다발

### Phase 3.6: 서랍에서 대화 (10-20회)
```
부엉: "(서랍을 열며) ...네 기억이 여기 있어. 좀 더 자세히 이야기해봐."
입력: 자유 입력 ✅
대화 횟수: 카운트 시작
조건: 10회 이상 대화 → 자동으로 Phase 4
```

**프롬프트 지침**:
- 최소 10회, 필요하면 최대 20회
- 더 구체적이고 날카로운 질문
- 핵심을 찌르는 통찰

### Phase 4: 편지 발견 (자동)
```
부엉: "찾았다. 이거군. (먼지를 털어내며)"
부엉: "10년 전의 네가, 지금의 너에게 보낸 편지다..."

━━━━━━━━━━━━━━━
[AI 생성 편지]
To. 지금의 나에게.
...
━━━━━━━━━━━━━━━
```

### Phase 5: 엔딩
```
부엉: "편지는 찾았으니 볼일은 끝났군."
부엉: "여기, '시든 꽃'... 잃어버리지 말고."
부엉: "이만 가보라고. ...너무 늦기 전에 답장하러 오든가."
```

---

## 📈 대화 횟수 관리

### 설정 값 (chatbot_service.py 상단)
```python
MIN_ROOM_CONVERSATIONS = 5    # 테스트: 5, 프로덕션: 10
MAX_ROOM_CONVERSATIONS = 10   # 테스트: 10, 프로덕션: 20
MIN_DRAWER_CONVERSATIONS = 5  # 테스트: 5, 프로덕션: 10
MAX_DRAWER_CONVERSATIONS = 10 # 테스트: 10, 프로덕션: 20
```

### room_conversation_count
- Phase 3에서 매 대화마다 +1
- MIN_ROOM_CONVERSATIONS 이상 → Phase 3.5로 자동 전환

### drawer_conversation_count
- Phase 3.6에서 매 대화마다 +1
- MIN_DRAWER_CONVERSATIONS 이상 → Phase 4로 자동 전환

### 총 대화 횟수
- **현재 (테스트)**: 10회 (방 5회 + 서랍 5회)
- **프로덕션**: 20-40회 (방 10-20회 + 서랍 10-20회)

---

## 🤖 AI의 역할

### 서랍 이름 생성
- 유저와의 대화 분석
- 선택한 방과 연관
- 은유적이고 시적인 이름
- 예시 참고하여 창의적 생성

### 편지 작성
- 총 20-40회의 대화 내용 분석
- 10년 전/후의 나의 시점
- 유저가 필요로 하는 위로/격려
- 진솔하고 따뜻한 어조

---

## ✅ 테스트 시나리오 (빠른 버전)

현재 설정: 각 10회씩, 총 20회 대화

1. Phase 1 → 버튼 클릭
2. Phase 2 → 방 선택 버튼
3. Phase 3 → 10번 대화 입력
4. Phase 3.5 → 자동 (서랍 선택)
5. Phase 3.6 → 10번 대화 입력
6. Phase 4 → 자동 (편지 생성)
7. Phase 5 → 엔딩

**총 테스트 시간: 약 5-10분**

